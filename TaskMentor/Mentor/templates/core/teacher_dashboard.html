{% extends 'core/base.html' %}

{% block title %}–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç —É—á–∏—Ç–µ–ª—è - TaskMentor{% endblock %}

{% block content %}
{% csrf_token %}
<div class="container mt-5 mb-5">

    <div class="row">
      <div class="col-12">
        <div class="tm-page-header mb-4">
          <h1 class="tm-page-title mb-1">–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç —É—á–∏—Ç–µ–ª—è</h1>
          <div class="tm-page-subtitle">TaskMentor ‚Ä¢ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —É—á–µ–Ω–∏–∫–∞–º–∏ –∏ –∑–∞–¥–∞—á–∞–º–∏</div>
        </div>
      </div>
    </div>

    <div class="row g-3 mt-1">
      <div class="col-12 col-lg-8">
        <div class="card h-100 tm-card-soft">
          <div class="card-header">
            <strong>–ü—Ä–æ—Ñ–∏–ª—å</strong>
          </div>
          <div class="card-body">
            <p><strong>–ò–º—è:</strong> {{ user.first_name }}</p>
            <p><strong>–¢–µ–ª–µ—Ñ–æ–Ω:</strong> {{ user.phone }}</p>
            <p><strong>Telegram:</strong> {{ user.telegram|default:"–ù–µ —É–∫–∞–∑–∞–Ω" }}</p>
          </div>
        </div>
      </div>

      <div class="col-12 col-lg-4">
        <div class="card h-100 tm-card-soft">
          <div class="card-header">
            <strong>Google Calendar</strong>
          </div>
          <div class="card-body">
            {% if has_calendar_token %}
              <div class="alert tm-alert-calendar">
                <i class="fas fa-check-circle"></i> Google Calendar –ø–æ–¥–∫–ª—é—á—ë–Ω
                <small class="d-block text-muted mt-1">–ó–∞–¥–∞—á–∏ –±—É–¥—É—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å—Å—è</small>
              </div>
            {% else %}
              <p>–ü–æ–¥–∫–ª—é—á–∏—Ç–µ Google Calendar –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –∑–∞–¥–∞—á</p>
              <a href="/accounts/google/login/?process=connect&next=/teacher/dashboard/" class="btn btn-primary">
                <i class="fab fa-google"></i> –ü–æ–¥–∫–ª—é—á–∏—Ç—å Google Calendar
              </a>
              <small class="d-block text-muted mt-2">
                –ü–æ—Å–ª–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –Ω–æ–≤—ã–µ –∑–∞–¥–∞—á–∏ –±—É–¥—É—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è –≤ –≤–∞—à –∫–∞–ª–µ–Ω–¥–∞—Ä—å
              </small>
            {% endif %}
          </div>
        </div>
      </div>
    </div>


    <div class="row mt-4">
        <div class="col-12">
            <h3>–ó–∞—è–≤–∫–∏ —É—á–µ–Ω–∏–∫–æ–≤ <span class="badge bg-primary">{{ applications.count }}</span></h3>
            {% for app in applications %}
            <div class="card mb-3">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <div>
                        <strong>{{ app.email }}</strong> - {{ app.nickname }}
                        <span class="badge bg-warning ms-2">{{ app.status.title }}</span>
                    </div>
                    <small class="text-muted">{{ app.created_at|date:"d.M.Y H:i" }}</small>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>–ò–º—è:</strong> {{ app.first_name }}</p>
                            <p><strong>–¢–µ–ª–µ—Ñ–æ–Ω:</strong> {{ app.phone }}</p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Telegram:</strong> {{ app.telegram|default:"–ù–µ —É–∫–∞–∑–∞–Ω" }}</p>
                        </div>
                    </div>
                    <div class="mt-2">
                        <label for="password{{ app.id }}" class="form-label">
                            –ü–∞—Ä–æ–ª—å —É—á–µ–Ω–∏–∫–∞:</label>
                        <input type="password" class="form-control form-control-sm"
                               id="password{{ app.id }}" placeholder="–ü—Ä–∏–¥—É–º–∞–π—Ç–µ –ø–∞—Ä–æ–ª—å –¥–ª—è —É—á–µ–Ω–∏–∫–∞">
                    </div>
                    <div class="mt-3">
                        <button class="btn btn-success btn-sm me-2" onclick="approveWithPassword({{ app.id }})">
                            <i class="fas fa-check"></i> –û–¥–æ–±—Ä–∏—Ç—å
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="toggleAppStatus({{ app.id }}, 'reject')">
                            <i class="fas fa-times"></i> –û—Ç–∫–ª–æ–Ω–∏—Ç—å
                        </button>
                    </div>
                </div>
            </div>
            {% empty %}
            <div class="alert alert-info text-center">
                <i class="fas fa-inbox fa-3x mb-3 opacity-50"></i>
                <h4>–ó–∞—è–≤–æ–∫ –Ω–µ—Ç</h4>
                <p>–ó–∞—è–≤–∫–∏ —É—á–µ–Ω–∏–∫–æ–≤ –±—É–¥—É—Ç –ø–æ—è–≤–ª—è—Ç—å—Å—è –∑–¥–µ—Å—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.</p>
            </div>
            {% endfor %}
        </div>
    </div>
          <!-- –°–ø–∏—Å–æ–∫ —É—á–µ–Ω–∏–∫–æ–≤ –∏ —Å–æ–∑–¥–∞–Ω–∏–µ –∑–∞–¥–∞—á -->
    <div class="row mt-5">
      <div class="col-12">
        <h3 class="mb-3">–ú–æ–∏ —É—á–µ–Ω–∏–∫–∏
          <span class="badge bg-success">{{ students.count }}</span>
        </h3>
          <!-- –§–∏–ª—å—Ç—Ä –æ–±—â–∏–π -->
          <form method="GET" class="mb-3">
             <select name="filter" onchange="this.form.submit()" class="form-select form-select-sm w-auto">
               <option value="pending" {% if filter_status == 'pending' %}selected{% endif %}>–ü–æ–∫–∞–∑–∞—Ç—å –Ω–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ</option>
               <option value="all" {% if filter_status == 'all' %}selected{% endif %}>–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ</option>
             </select>
           </form>
           <!-- ---------- -->
        <div class="row g-3">
          {% for student_profile in students %}
          <div class="col-12 col-lg-6">
            <div class="card h-100">
              <div class="card-header d-flex justify-content-between">
                <strong>{{ student_profile.user.first_name }} ({{ student_profile.user.email }})</strong>
                <span class="badge bg-info">{{ student_profile.user.tasks.count }} –∑–∞–¥–∞—á</span>
              </div>
              <div class="card-body">

                <!-- –ü—Ä–æ–≥—Ä–µ—Å—Å -->
                <div class="mb-3">
                  <small>–ü—Ä–æ–≥—Ä–µ—Å—Å: {{ student_profile.progress }}% ({{ student_profile.completed_tasks }}/
                      {{ student_profile.total_tasks }})</small>
                  <div class="progress">
                    <div class="progress-bar" style="width: {{ student_profile.progress }}%;"></div>
                  </div>
                </div>
                <!-- –ü–æ—Å–ª–µ–¥–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è -->
                <div class="mb-2">
                  <small>–ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π):</small>
                  {% for mood in student_profile.recent_moods %}
                    <span class="badge
                      {% if mood.mood == 'great' %}bg-success
                      {% elif mood.mood == 'good' %}bg-warning
                      {% else %}bg-danger{% endif %} me-1">
                      {{ mood.get_mood_display }} {{ mood.date|date:"d.m" }}
                    </span>
                  {% empty %}
                    <span class="badge bg-secondary">–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö</span>
                  {% endfor %}
                </div>
                <!-- --------------------- -->
                <p><strong>–ù–∏–∫: </strong>{{ student_profile.nickname }}</p>
                <button class="btn btn-primary btn-sm" onclick="openCreateTaskModal({{ student_profile.user.id }})">
                  –°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á—É
                </button>
                <!-- –°–ø–∏—Å–æ–∫ –∑–∞–¥–∞—á —ç—Ç–æ–≥–æ —É—á–µ–Ω–∏–∫–∞ -->
                <div class="mt-3">
                  <h6>–ó–∞–¥–∞—á–∏:</h6>
                    {% for task in student_profile.user.tasks.all %}
                      {% if filter_status == 'all' or not task.is_completed %}
                        <div class="task-item mb-1 p-2 border rounded" data-task-id="{{ task.id }}">
                          <strong>{{ task.title }}</strong>
                          <span class="badge {{ task.is_completed|yesno:'bg-success,bg-warning' }}">{{ task.is_completed|yesno:"‚úì,‚è≥" }}</span>

                          <small class="d-block">
                            {% if not task.is_completed and task.due_date %}
                              {% if task.due_date < now %}
                                <span class="badge tm-badge-overdue me-1">–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ</span>
                              {% endif %}
                            {% endif %}
                            {{ task.due_date|date:"d.m.Y H:i" }}
                          </small>
                          <!-- –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:-->
                          <small class="d-block text-muted">
                            –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:
                            {% if task.priority == 'high' %}
                              <span class="badge tm-priority tm-priority--high">–í—ã—Å–æ–∫–∏–π</span>
                            {% elif task.priority == 'medium' %}
                              <span class="badge tm-priority tm-priority--medium">–°—Ä–µ–¥–Ω–∏–π</span>
                            {% else %}
                              <span class="badge tm-priority tm-priority--low">–ù–∏–∑–∫–∏–π</span>
                            {% endif %}
                          </small>

                          <div class="mt-1">
                            {% if not task.is_completed %}
                              <button class="btn btn-outline-primary btn-sm me-1" onclick="deleteTask({{ task.id }})" title="–£–¥–∞–ª–∏—Ç—å">üóëÔ∏è
<!--                                <i class="fas fa-trash"></i>-->
                              </button>
                            {% endif %}
                            <button class="btn btn-sm btn-outline-primary" onclick="openEditTaskModal({{ task.id }})">‚úèÔ∏è</button>
                          </div>
                        </div>
                      {% endif %}
                    {% empty %}
                      <small class="text-muted">–ù–µ—Ç –∑–∞–¥–∞—á</small>
                    {% endfor %}
                </div>  <!-- /.mt-3 -->
              </div>    <!-- /.card-body -->
            </div>
          </div> <!-- /.card -->
        {% empty %}
        <div class="alert alert-info">–ù–µ—Ç —É—á–µ–Ω–∏–∫–æ–≤. –û–¥–æ–±—Ä–∏—Ç–µ –∑–∞—è–≤–∫–∏ –≤—ã—à–µ.</div>
        {% endfor %}
       </div>
        </div>        <!-- /.col-12 -->
    </div>          <!-- /.row mt-5 -->


    <!-- –ú–æ–¥–∞–ª–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–¥–∞—á–∏ -->
    <div class="modal fade" id="createTaskModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">–ù–æ–≤–∞—è –∑–∞–¥–∞—á–∞</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <form method="post" action="{% url 'create_task' %}" id="taskForm">
            {% csrf_token %}
            <div class="modal-body">
              <input type="hidden" name="student_id" id="studentId">
              <div class="mb-3">
                <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
                <input type="text" class="form-control" name="title" required>
              </div>
              <div class="mb-3">
                <label class="form-label">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                <textarea class="form-control" name="description" rows="3"></textarea>
              </div>
              <div class="mb-3">
                <label class="form-label">–î–µ–¥–ª–∞–π–Ω</label>
                <input type="datetime-local" class="form-control" name="due_date" required>
              </div>
              <div class="mb-3">
                <label class="form-label">–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç</label>
                <select class="form-control" name="priority">
                  <option value="low">–ù–∏–∑–∫–∏–π</option>
                  <option value="medium" selected>–°—Ä–µ–¥–Ω–∏–π</option>
                  <option value="high">–í—ã—Å–æ–∫–∏–π</option>
                </select>
              </div>
            <!-- ‚úÖ –ù–û–í–´–ô checkbox –¥–ª—è Calendar sync (—Å—Ç—Ä–æ–∫–∞ –ø–æ—Å–ª–µ priority) -->
              <div class="form-check mb-3 mt-3">
                <input class="form-check-input" type="checkbox" name="sync_calendar" id="syncCalendar" checked>
                <label class="form-check-label" for="syncCalendar">
                üìÖ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Å Google Calendar (–µ—Å–ª–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω)
                </label>
                <div class="form-text small">
                  –°–æ–∑–¥–∞—Å—Ç —Å–æ–±—ã—Ç–∏–µ –≤ —Ç–≤–æ—ë–º Google –∫–∞–ª–µ–Ω–¥–∞—Ä–µ
                </div>
              </div>
            <!-- ------------------------------------ -->
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
              <button type="submit" class="btn btn-primary">–°–æ–∑–¥–∞—Ç—å</button>
            </div>
          </form>
        </div>
      </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª–∫–∞ –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–Ø -->
<div class="modal fade" id="editTaskModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–¥–∞—á—É</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <form method="post" action="{% url 'edit_task' %}">
        {% csrf_token %}
        <div class="modal-body">
          <input type="hidden" name="task_id" id="editTaskId">
          <div class="mb-3">
            <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
            <input type="text" class="form-control" name="title" id="editTitle" required>
          </div>
          <div class="mb-3">
            <label class="form-label">–û–ø–∏—Å–∞–Ω–∏–µ</label>
            <textarea class="form-control" name="description" id="editDescription" rows="3"></textarea>
          </div>
          <div class="mb-3">
            <label class="form-label">–î–µ–¥–ª–∞–π–Ω</label>
            <input type="datetime-local" class="form-control" name="due_date" id="editDueDate" required>
          </div>
          <div class="mb-3">
            <label class="form-label">–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç</label>
            <select class="form-control" name="priority" id="editPriority">
              <option value="low">–ù–∏–∑–∫–∏–π</option>
              <option value="medium">–°—Ä–µ–¥–Ω–∏–π</option>
              <option value="high">–í—ã—Å–æ–∫–∏–π</option>
            </select>
          </div>

        <!-- ‚úÖ Goggl–µ –∫–∞–ª–µ–Ω–¥–∞—Ä—å –≤ —Ä–µ–¥–∞–∫—Ç–∏—Ä–≤–æ–∞–Ω–∏–∏ -->
          <div class="form-check mb-3 mt-3">
            <input class="form-check-input" type="checkbox" name="sync_calendar" id="editSyncCalendar">
            <label class="form-check-label" for="editSyncCalendar">
              üìÖ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Å Google Calendar
            </label>
          </div>
           <!-- ---------------------------------- -->
               <!-- ‚úÖ –¢–æ—Ç –∂–µ checkbox –¥–ª—è edit -->
<!--            –Ω–∏–∂–µ –∑–∞–∫–æ–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω –±–ª–æ–∫ –≥–∞–ª–æ—á–∫–∏ –í—ã–ø–æ–ª–Ω–µ–Ω–æ –¥–ª—è —É—á–∏—Ç–µ–ª—è-->
<!--          <div class="form-check">-->
<!--            <input class="form-check-input" type="checkbox" name="is_completed" id="editCompleted">-->
<!--            <label class="form-check-label" for="editCompleted">–í—ã–ø–æ–ª–Ω–µ–Ω–æ</label>-->
<!--          </div>-->
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
          <button type="submit" class="btn btn-warning">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
function toggleAppStatus(appId, action) {
    if (confirm(action === 'approve' ? '–û–¥–æ–±—Ä–∏—Ç—å –∑–∞—è–≤–∫—É?' : '–û—Ç–∫–ª–æ–Ω–∏—Ç—å –∑–∞—è–≤–∫—É?')) {
        fetch(`/toggle-app/${appId}/${action}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            credentials: 'same-origin'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert(data.message);
            }
        })
        .catch(error => {
            alert('–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞');
        });
    }
}
function approveWithPassword(appId) {
    const password = document.getElementById('password' + appId).value;
    if (!password) {
        alert('–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å –¥–ª—è —É—á–µ–Ω–∏–∫–∞');
        return;
    }
    fetch(`/toggle-app/${appId}/approve/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            'X-Student-Password': password
        },
        credentials: 'same-origin'
    })
    .then(r => r.json())
    .then(d => {
        if (d.success) location.reload();
        else alert(d.message);
    })
    .catch(e => alert('–û—à–∏–±–∫–∞'));
}
function openCreateTaskModal(studentId) {
  console.log('–û—Ç–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª–∫–∏ –¥–ª—è:', studentId);

  const modalElement = document.getElementById('createTaskModal');

  // 1. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º ID —É—á–µ–Ω–∏–∫–∞
  document.getElementById('studentId').value = studentId;
  document.querySelector('#createTaskModal .modal-title').textContent = `–ó–∞–¥–∞—á–∞ –¥–ª—è —É—á–µ–Ω–∏–∫–∞ ID ${studentId}`;

  // 2. –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ backdrop
  document.querySelectorAll('.modal-backdrop').forEach(el => el.remove());
  document.body.classList.remove('modal-open');

  // 3. –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤–æ–∑–º–æ–∂–Ω—ã–µ inline-—Å—Ç–∏–ª–∏
  modalElement.style = '';

  // 4. –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–∞—Ç–∏–≤–Ω—ã–π Bootstrap
  const modal = new bootstrap.Modal(modalElement, {
    backdrop: 'static',
    keyboard: true
  });

  // 5. –ü–æ–∫–∞–∑—ã–≤–∞–µ–º
  modal.show();

  // 6. –ü–æ—Å–ª–µ –ø–æ–∫–∞–∑–∞ –£–ë–ï–î–ò–¢–ï–õ–¨–ù–û —Å—Ç–∞–≤–∏–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏
  modalElement.addEventListener('shown.bs.modal', function() {
    // –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏
    modalElement.style.display = 'block';
    modalElement.style.opacity = '1';
    modalElement.style.zIndex = '1055';

    // Backdrop –º–æ–≥ –Ω–µ —Å–æ–∑–¥–∞—Ç—åc—è - —Å–æ–∑–¥–∞–µ–º –µ—Å–ª–∏ –Ω–µ—Ç
    if (!document.querySelector('.modal-backdrop')) {
      const backdrop = document.createElement('div');
      backdrop.className = 'modal-backdrop fade show';
      backdrop.style.cssText = 'position:fixed;top:0;left:0;width:100vw;height:100vh;z-index:1050;background:rgba(0,0,0,0.5)';
      document.body.appendChild(backdrop);
    }

    // Body –∫–ª–∞—Å—Å
    document.body.classList.add('modal-open');

    // –§–æ–∫—É—Å –Ω–∞ –ø–æ–ª–µ
    const input = modalElement.querySelector('input[name="title"]');
    if (input) setTimeout(() => input.focus(), 100);
  }, { once: true });
}
function openEditTaskModal(taskId) {
  console.log('–û—Ç–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª–∫–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è –∑–∞–¥–∞—á–∏:', taskId);

  const modalElement = document.getElementById('editTaskModal');

  // 1. ID –∑–∞–¥–∞—á–∏
  document.getElementById('editTaskId').value = taskId;

  // 2. –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∑–∞–¥–∞—á–∏ –ø–æ AJAX
  fetch(`/get-task/${taskId}/`)
    .then(response => response.json())
    .then(data => {
      document.getElementById('editTitle').value = data.title;
      document.getElementById('editDescription').value = data.description || '';
      document.getElementById('editDueDate').value = data.due_date.slice(0,16); // YYYY-MM-DDTHH:MM
      document.getElementById('editPriority').value = data.priority;
      document.getElementById('editSyncCalendar').checked = false;  // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é off –¥–ª—è edit google –∫–∞–ª–µ–Ω–¥–∞—Ä—å
       // —Å—Ç—Ä–æ–∫–∞ –Ω–∏–∂–µ –∑–∞–∫–æ–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–ª–∞ –≥–∞–ª–æ—á–∫—É –í—ã–ø–æ–ª–Ω–µ–Ω–æ –¥–ª—è —É—á–∏—Ç–µ–ª—è
<!--      document.getElementById('editCompleted').checked = data.is_completed;-->
      document.querySelector('#editTaskModal .modal-title').textContent = `–ó–∞–¥–∞—á–∞: ${data.title}`;

      // 3. –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ backdrop
      document.querySelectorAll('.modal-backdrop').forEach(el => el.remove());
      document.body.classList.remove('modal-open');

      // 4. –°–±—Ä–æ—Å —Å—Ç–∏–ª–µ–π
      modalElement.style = '';

      // 5. Bootstrap
      const modal = new bootstrap.Modal(modalElement, {backdrop: 'static', keyboard: true});
      modal.show();

      // 6. –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –ø–æ—Å–ª–µ –ø–æ–∫–∞–∑–∞ (—Ç–≤–æ—è –º–∞–≥–∏—è!)
      modalElement.addEventListener('shown.bs.modal', function() {
        modalElement.style.display = 'block';
        modalElement.style.opacity = '1';
        modalElement.style.zIndex = '1055';

        if (!document.querySelector('.modal-backdrop')) {
          const backdrop = document.createElement('div');
          backdrop.className = 'modal-backdrop fade show';
          backdrop.style.cssText = 'position:fixed;top:0;left:0;width:100vw;height:100vh;z-index:1050;background:rgba(0,0,0,0.5)';
          document.body.appendChild(backdrop);
        }

        document.body.classList.add('modal-open');
        document.getElementById('editTitle').focus();
      }, { once: true });
    })
    .catch(error => {
      console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–¥–∞—á–∏:', error);
      alert('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏');
    });
}
function deleteTask(taskId) {
    if (!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç—É –∑–∞–¥–∞—á—É –Ω–∞–≤—Å–µ–≥–¥–∞?')) return;

    fetch(`/api/task/${taskId}/delete/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json',
        },
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();  // –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É
        } else {
            alert(data.error);
        }
    })
    .catch(() => alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è'));
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

</script>
{% endblock %}